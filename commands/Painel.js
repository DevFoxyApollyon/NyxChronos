const { SlashCommandBuilder, ModalBuilder, TextInputBuilder, TextInputStyle, ActionRowBuilder, EmbedBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const mongoose = require('mongoose');

// Schema do servidor para armazenar configura√ß√µes no MongoDB
const servidorSchema = new mongoose.Schema({
    spreadsheetId: { type: String, maxlength: 500 }, // ID da planilha
    sheetName: { type: String, maxlength: 500 }, // Nome da aba na planilha
    cargoPermitido: { type: String, maxlength: 500 }, // Cargo que pode usar o sistema
    responsavelHoras: { type: String, maxlength: 500 }, // Nome do respons√°vel pelas horas
    channelId: { type: String, maxlength: 500 }, // Canal de envio dos dados
    guildId: { type: String, unique: true, required: true }, // ID do servidor (√∫nico)
    GOOGLE_CREDENTIALS_PATH: { type: String, maxlength: 500 }, // Adicionando o campo para o caminho do arquivo de credenciais
    showEmbed: { type: Boolean, default: true }, // Adicionando o campo para controlar a exibi√ß√£o da embed no modal de configura√ß√£o
    blocked: { type: Boolean, default: false } // Adicionando o campo para controlar o estado do servidor
});

// Cria√ß√£o ou reuso do modelo
const Servidor = mongoose.models.Servidor || mongoose.model('Servidor', servidorSchema);

// Fun√ß√£o para salvar ou atualizar as configura√ß√µes no banco de dados
const saveConfig = async (config) => {
    try {
        console.log('Tentando salvar configura√ß√£o:', config);
        
        // Verifica se o mongoose est√° conectado
        if (mongoose.connection.readyState !== 1) {
            console.error('MongoDB n√£o est√° conectado. Estado atual:', mongoose.connection.readyState);
            throw new Error('MongoDB n√£o est√° conectado');
        }

        const result = await Servidor.findOneAndUpdate(
            { guildId: config.guildId },
            config,
            { upsert: true, new: true }
        );

        console.log('Configura√ß√£o salva com sucesso:', result);
        return result;
    } catch (error) {
        console.error('Erro detalhado ao salvar a configura√ß√£o:', error);
        throw error;
    }
};

const handlePainelCommand = async (interaction) => {
    try {
        // Verificar se √© o administrador do bot
        const isAdmin = interaction.user.id === '657014871228940336'; // ID do suporte

        // Se n√£o for administrador, verificar permiss√µes do bot
        if (!isAdmin) {
            if (!interaction.guild.members.me.permissions.has(['SendMessages', 'EmbedLinks', 'ManageMessages'])) {
                const permissionEmbed = new EmbedBuilder()
                    .setColor('#FF0000')
                    .setTitle('‚ùå Permiss√µes Insuficientes')
                    .setDescription('O bot n√£o possui as permiss√µes necess√°rias para funcionar corretamente.')
                    .addFields(
                        { 
                            name: 'üîê Permiss√µes Necess√°rias', 
                            value: '‚Ä¢ `Enviar Mensagens`\n‚Ä¢ `Incorporar Links`\n‚Ä¢ `Gerenciar Mensagens`', 
                            inline: false 
                        },
                        {
                            name: 'üìù Como Resolver',
                            value: 'Pe√ßa a um administrador para verificar as permiss√µes do bot no servidor.',
                            inline: false
                        }
                    )
                    .setTimestamp()
                    .setFooter({ 
                        text: 'Sistema de Bate Ponto Nychronos', 
                        iconURL: interaction.guild.iconURL({ dynamic: true }) 
                    });

                return await interaction.reply({
                    embeds: [permissionEmbed],
                    ephemeral: true
                });
            }

            // Verificar permiss√£o do usu√°rio
            if (!interaction.member.permissions.has('Administrator')) {
                // Notificar o suporte
                try {
                    const SUPPORT_ID = '657014871228940336';
                    const suporteUser = await interaction.client.users.fetch(SUPPORT_ID);
                    
                    const suporteEmbed = new EmbedBuilder()
                        .setColor('#FF0000')
                        .setTitle('‚ö†Ô∏è Tentativa de Acesso ao Painel')
                        .setDescription(`Um usu√°rio tentou acessar o comando /painel sem permiss√£o.`)
                        .addFields(
                            { name: 'üë§ Usu√°rio', value: `<@${interaction.user.id}> (${interaction.user.tag})`, inline: true },
                            { name: 'üÜî ID do Usu√°rio', value: `\`${interaction.user.id}\``, inline: true },
                            { name: 'üè¢ Servidor', value: `${interaction.guild.name}`, inline: true },
                            { name: 'üÜî ID do Servidor', value: `\`${interaction.guild.id}\``, inline: true }
                        )
                        .setThumbnail(interaction.user.displayAvatarURL({ dynamic: true }))
                        .setTimestamp()
                        .setFooter({ 
                            text: 'Sistema de Bate Ponto Nychronos',
                            iconURL: interaction.client.user.displayAvatarURL()
                        });

                    await suporteUser.send({ embeds: [suporteEmbed] });
                } catch (err) {
                    console.error('Erro ao enviar notifica√ß√£o para o suporte:', err);
                }

                const accessEmbed = new EmbedBuilder()
                    .setColor('#FF0000')
                    .setTitle('üîí Acesso Negado')
                    .setDescription('Voc√™ n√£o tem permiss√£o para utilizar este comando.')
                    .addFields(
                        { 
                            name: '‚ö†Ô∏è Requisitos', 
                            value: 'Para usar este comando, voc√™ precisa ter permiss√£o de Administrador no servidor.', 
                            inline: false 
                        }
                    )
                    .setThumbnail(interaction.guild.iconURL({ dynamic: true }))
                    .setTimestamp()
                    .setFooter({ 
                        text: 'Sistema de Bate Ponto Nychronos', 
                        iconURL: interaction.guild.iconURL({ dynamic: true }) 
                    });

                return await interaction.reply({
                    embeds: [accessEmbed],
                    ephemeral: true
                });
            }
        }

        // Procura a configura√ß√£o existente no banco
        const servidor = await Servidor.findOne({ guildId: interaction.guild.id });

        // Se existir, exibe as informa√ß√µes
        if (servidor) {
            const embed = new EmbedBuilder()
                .setColor('#2b2d31')
                .setTitle('‚öôÔ∏è Configura√ß√µes do Servidor')
                .setDescription('Abaixo est√£o listadas todas as configura√ß√µes atuais do servidor.')
                .addFields(
                    {
                        name: 'üìä Planilha',
                        value: `\`\`\`${servidor.spreadsheetId || 'N√£o configurado'}\`\`\``,
                        inline: false
                    },
                    {
                        name: 'üìë Aba da Planilha',
                        value: `\`\`\`${servidor.sheetName || 'N√£o configurado'}\`\`\``,
                        inline: false
                    },
                    {
                        name: 'üë• Cargos',
                        value: [
                            `**Cargo Permitido:** ${servidor.cargoPermitido ? `<@&${servidor.cargoPermitido}>` : '`N√£o configurado`'}`,
                            `**Respons√°vel por Horas:** ${servidor.responsavelHoras ? `<@&${servidor.responsavelHoras}>` : '`N√£o configurado`'}`
                        ].join('\n'),
                        inline: false
                    },
                    {
                        name: 'üìù Canal de Logs',
                        value: servidor.channelId ? `<#${servidor.channelId}>` : '`N√£o configurado`',
                        inline: false
                    }
                )
                .setThumbnail(interaction.guild.iconURL({ dynamic: true }))
                .setTimestamp()
                .setFooter({ 
                    text: 'Sistema de Bate Ponto Nychronos',
                    iconURL: interaction.guild.iconURL({ dynamic: true })
                });

            // Criar bot√£o para acessar a planilha
            const row = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setLabel('Acessar Planilha')
                        .setStyle(ButtonStyle.Link)
                        .setURL(`https://docs.google.com/spreadsheets/d/${servidor.spreadsheetId}`)
                        .setEmoji('üìä')
                        .setDisabled(!servidor.spreadsheetId)
                );

            await interaction.reply({ 
                embeds: [embed], 
                components: [row],
                ephemeral: true 
            });
        } else {
            // Se n√£o existir, exibe o modal para preencher os dados
            const modal = new ModalBuilder()
                .setCustomId('serverConfigModal')
                .setTitle('Configura√ß√µes do Servidor');

            // Cria√ß√£o dos campos do modal
            const spreadsheetIdInput = new TextInputBuilder()
                .setCustomId('spreadsheetId')
                .setLabel('ID da Planilha do Google Sheets')
                .setStyle(TextInputStyle.Short)
                .setPlaceholder('Cole o ID da sua planilha aqui')
                .setRequired(true);

            const sheetNameInput = new TextInputBuilder()
                .setCustomId('sheetName')
                .setLabel('Nome da Aba')
                .setStyle(TextInputStyle.Short)
                .setPlaceholder('Nome da aba onde os dados ser√£o salvos')
                .setRequired(true);

            const cargoPermitidoInput = new TextInputBuilder()
                .setCustomId('cargoPermitido')
                .setLabel('ID do Cargo Permitido')
                .setStyle(TextInputStyle.Short)
                .setPlaceholder('Cole o ID num√©rico do cargo (ative o Modo Desenvolvedor)')
                .setRequired(true);

            const responsavelHorasInput = new TextInputBuilder()
                .setCustomId('responsavelHoras')
                .setLabel('ID do Cargo Respons√°vel pelas Horas')
                .setStyle(TextInputStyle.Short)
                .setPlaceholder('Cole o ID num√©rico do cargo (ative o Modo Desenvolvedor)')
                .setRequired(true);

            const channelIdInput = new TextInputBuilder()
                .setCustomId('channelId')
                .setLabel('ID do Canal de Log')
                .setStyle(TextInputStyle.Short)
                .setPlaceholder('Cole o ID num√©rico do canal (ative o Modo Desenvolvedor)')
                .setRequired(true);

            // Cria√ß√£o das linhas do modal
            const firstActionRow = new ActionRowBuilder().addComponents(spreadsheetIdInput);
            const secondActionRow = new ActionRowBuilder().addComponents(sheetNameInput);
            const thirdActionRow = new ActionRowBuilder().addComponents(cargoPermitidoInput);
            const fourthActionRow = new ActionRowBuilder().addComponents(responsavelHorasInput);
            const fifthActionRow = new ActionRowBuilder().addComponents(channelIdInput);

            // Adiciona as linhas ao modal
            modal.addComponents(firstActionRow, secondActionRow, thirdActionRow, fourthActionRow, fifthActionRow);

            await interaction.showModal(modal);
        }
    } catch (error) {
        console.error('Erro ao executar comando /painel:', error);
        
        // Tratamento espec√≠fico para diferentes tipos de erro
        if (error.code === 'INTERACTION_ALREADY_REPLIED') {
            return;
        }
        
        if (error.code === 'INTERACTION_TIMEOUT') {
            const timeoutEmbed = new EmbedBuilder()
                .setColor('#FFA500')
                .setTitle('‚è∞ Tempo Expirado')
                .setDescription('A intera√ß√£o expirou devido ao tempo limite.')
                .addFields(
                    { 
                        name: 'üîÑ Pr√≥ximos Passos', 
                        value: 'Por favor, tente executar o comando novamente.', 
                        inline: false 
                    }
                )
                .setTimestamp()
                .setFooter({ 
                    text: 'Sistema de Bate Ponto Nychronos', 
                    iconURL: interaction.guild.iconURL({ dynamic: true }) 
                });

            return await interaction.followUp({ 
                embeds: [timeoutEmbed],
                ephemeral: true 
            }).catch(() => {});
        }

        // Erro gen√©rico mais informativo
        try {
            const errorEmbed = new EmbedBuilder()
                .setColor('#FF0000')
                .setTitle('‚ùå Erro no Sistema')
                .setDescription('Ocorreu um erro ao processar o comando.')
                .addFields(
                    { 
                        name: '‚ö†Ô∏è Detalhes do Erro', 
                        value: '```' + error.message + '```', 
                        inline: false 
                    },
                    {
                        name: 'üîÑ Sugest√£o',
                        value: 'Por favor, tente novamente. Se o problema persistir, contate um administrador.',
                        inline: false
                    }
                )
                .setTimestamp()
                .setFooter({ 
                    text: 'Sistema de Bate Ponto Nychronos', 
                    iconURL: interaction.guild.iconURL({ dynamic: true }) 
                });

            await interaction.reply({ 
                embeds: [errorEmbed],
                ephemeral: true 
            });
        } catch {
            // Se n√£o conseguir responder √† intera√ß√£o original, tenta enviar uma nova
            const fallbackEmbed = new EmbedBuilder()
                .setColor('#FF0000')
                .setTitle('‚ùå Erro no Sistema')
                .setDescription('Ocorreu um erro ao processar o comando.')
                .addFields(
                    {
                        name: 'üîÑ Sugest√£o',
                        value: 'Por favor, tente novamente mais tarde.',
                        inline: false
                    }
                )
                .setTimestamp()
                .setFooter({ 
                    text: 'Sistema de Bate Ponto Nychronos', 
                    iconURL: interaction.guild.iconURL({ dynamic: true }) 
                });

            await interaction.followUp({ 
                embeds: [fallbackEmbed],
                ephemeral: true 
            }).catch(() => {});
        }
    }
};

const handleInteraction = async (interaction) => {
    if (!interaction.isModalSubmit()) return;
    if (interaction.customId === 'serverConfigModal') {
        try {
            const spreadsheetId = interaction.fields.getTextInputValue('spreadsheetId');
            const sheetName = interaction.fields.getTextInputValue('sheetName');
            const channelId = interaction.fields.getTextInputValue('channelId');
            const cargoPermitido = interaction.fields.getTextInputValue('cargoPermitido');
            const responsavelHoras = interaction.fields.getTextInputValue('responsavelHoras');

            // Validar se os IDs fornecidos s√£o v√°lidos
            const errors = [];
            
            // Verificar se a planilha j√° est√° em uso em outro servidor
            const existingServer = await Servidor.findOne({ 
                spreadsheetId: spreadsheetId,
                guildId: { $ne: interaction.guild.id } // Exclui o servidor atual da busca
            });

            if (existingServer) {
                errors.push('Esta planilha j√° est√° configurada em outro servidor. Por favor, crie uma nova planilha para este servidor.');
            }
            
            // Validar channelId (deve ser num√©rico)
            if (!/^\d+$/.test(channelId)) {
                errors.push('O ID do canal de logs deve ser um ID v√°lido do Discord (apenas n√∫meros).');
            } else {
                try {
                    const channel = await interaction.guild.channels.fetch(channelId);
                    if (!channel) {
                        errors.push('Canal de logs n√£o encontrado neste servidor.');
                    }
                } catch (error) {
                    errors.push('Canal de logs n√£o encontrado ou inacess√≠vel.');
                }
            }
            
            // Validar cargoPermitido (deve ser num√©rico)
            if (!/^\d+$/.test(cargoPermitido)) {
                errors.push('O ID do cargo permitido deve ser um ID v√°lido do Discord (apenas n√∫meros).');
            } else {
                try {
                    const role = await interaction.guild.roles.fetch(cargoPermitido);
                    if (!role) {
                        errors.push('Cargo permitido n√£o encontrado neste servidor.');
                    }
                } catch (error) {
                    errors.push('Cargo permitido n√£o encontrado ou inacess√≠vel.');
                }
            }
            
            // Validar responsavelHoras (deve ser num√©rico)
            if (!/^\d+$/.test(responsavelHoras)) {
                errors.push('O ID do cargo respons√°vel por horas deve ser um ID v√°lido do Discord (apenas n√∫meros).');
            } else {
                try {
                    const role = await interaction.guild.roles.fetch(responsavelHoras);
                    if (!role) {
                        errors.push('Cargo respons√°vel por horas n√£o encontrado neste servidor.');
                    }
                } catch (error) {
                    errors.push('Cargo respons√°vel por horas n√£o encontrado ou inacess√≠vel.');
                }
            }
            
            // Se houver erros, retorna uma mensagem com os problemas
            if (errors.length > 0) {
                const errorEmbed = new EmbedBuilder()
                    .setColor('#FF0000')
                    .setTitle('‚ùå Erro na Configura√ß√£o')
                    .setDescription('Foram encontrados problemas com os dados fornecidos:')
                    .addFields(
                        { 
                            name: '‚ö†Ô∏è Erros Detectados', 
                            value: errors.map(err => `‚Ä¢ ${err}`).join('\n'), 
                            inline: false 
                        },
                        {
                            name: '‚ùì Como obter os IDs corretos',
                            value: 'Para obter um ID de canal: clique com o bot√£o direito no canal e selecione "Copiar ID".\nPara obter um ID de cargo: v√° em Configura√ß√µes do Servidor > Cargos, clique com o bot√£o direito no cargo e selecione "Copiar ID".\n\n**Nota:** Voc√™ precisa ter o Modo Desenvolvedor ativado nas configura√ß√µes do Discord para ver estas op√ß√µes.',
                            inline: false
                        }
                    )
                    .setTimestamp()
                    .setFooter({ 
                        text: 'Sistema de Bate Ponto Nychronos', 
                        iconURL: interaction.guild.iconURL({ dynamic: true }) 
                    });
                
                return await interaction.reply({ 
                    embeds: [errorEmbed], 
                    ephemeral: true 
                });
            }

            // Coleta os dados inseridos no modal
            const config = {
                guildId: interaction.guild.id,
                spreadsheetId,
                sheetName,
                cargoPermitido,
                responsavelHoras,
                channelId,
                GOOGLE_CREDENTIALS_PATH: './credentials.json'
            };

            console.log('üìù Configura√ß√£o:', {
                servidor: interaction.guild.name,
                planilha: sheetName,
                cargo: cargoPermitido,
                canal: channelId
            });

            // Tenta salvar a configura√ß√£o
            await saveConfig(config);
            
            console.log('‚úÖ Configura√ß√£o salva');

            // Buscar nome dos cargos
            let nomeCargoPermitido = 'Desconhecido';
            let nomeResponsavelHoras = 'Desconhecido';
            try {
                const cargoObj = await interaction.guild.roles.fetch(cargoPermitido);
                if (cargoObj) nomeCargoPermitido = cargoObj.name;
            } catch {}
            try {
                const respObj = await interaction.guild.roles.fetch(responsavelHoras);
                if (respObj) nomeResponsavelHoras = respObj.name;
            } catch {}

            // Criar embed de sucesso melhorada
            const guildOwner = await interaction.guild.fetchOwner();
            const memberCount = interaction.guild.memberCount;

            const successEmbed = new EmbedBuilder()
                .setColor('#2b2d31')
                .setTitle('üõ†Ô∏è Novo Servidor Configurado')
                .setDescription(`O servidor **${interaction.guild.name}** (${interaction.guild.id}) foi configurado usando o comando "/painel".`)
                .addFields(
                    { name: 'üë§ Configurado por', value: `<@${interaction.user.id}> (${interaction.user.tag})\n(\`${interaction.user.id}\`)`, inline: true },
                    { name: 'üÜî ID do Servidor', value: `\`${interaction.guild.id}\``, inline: true },
                    { name: 'üë• Membros', value: `${memberCount}`, inline: true },
                    { name: 'üëë Dono', value: `<@${guildOwner.id}>`, inline: true },
                    { name: 'üìä ID da Planilha', value: `\`${spreadsheetId}\``, inline: false },
                    { name: 'üìë Aba da Planilha', value: `\`${sheetName}\``, inline: false },
                    { name: 'üìù Canal de Logs', value: `<#${channelId}>`, inline: false },
                    {
                        name: 'üë• Cargos Configurados',
                        value: `**Cargo Permitido:** <@&${cargoPermitido}> (${nomeCargoPermitido})\n**Respons√°vel por Horas:** <@&${responsavelHoras}> (${nomeResponsavelHoras})`,
                        inline: false
                    }
                )
                .setThumbnail(interaction.guild.iconURL({ dynamic: true }))
                .setTimestamp()
                .setFooter({ 
                    text: `Hoje √†s ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`,
                    iconURL: interaction.user.displayAvatarURL({ dynamic: true })
                });

            // Criar bot√£o para acessar a planilha
            const row = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setLabel('Acessar Planilha')
                        .setStyle(ButtonStyle.Link)
                        .setURL(`https://docs.google.com/spreadsheets/d/${config.spreadsheetId}`)
                        .setEmoji('üìä')
                );

            const message = await interaction.reply({ 
                embeds: [successEmbed], 
                components: [row],
                ephemeral: true 
            });

            // Enviar mensagem privada para o suporte com o nome dos cargos
            try {
                const SUPPORT_ID = '657014871228940336';
                const suporteUser = await interaction.client.users.fetch(SUPPORT_ID);
                const suporteEmbed = new EmbedBuilder()
                    .setColor('#2b2d31')
                    .setTitle('üõ†Ô∏è Novo Servidor Configurado')
                    .setDescription(`O servidor **${interaction.guild.name}** (${interaction.guild.id}) foi configurado usando o comando "/painel".`)
                    .addFields(
                        { name: 'üë§ Configurado por', value: `<@${interaction.user.id}> (${interaction.user.tag})\n(\`${interaction.user.id}\`)`, inline: true },
                        { name: 'üÜî ID do Servidor', value: `\`${interaction.guild.id}\``, inline: true },
                        { name: 'üë• Membros', value: `${memberCount}`, inline: true },
                        { name: 'üëë Dono', value: `<@${guildOwner.id}>`, inline: true },
                        { name: 'üìä ID da Planilha', value: `\`${spreadsheetId}\``, inline: false },
                        { name: 'üìë Aba da Planilha', value: `\`${sheetName}\``, inline: false },
                        { name: 'üìù Canal de Logs', value: `<#${channelId}>`, inline: false },
                        {
                            name: 'üë• Cargos Configurados',
                            value: `**Cargo Permitido:** <@&${cargoPermitido}> (${nomeCargoPermitido})\n**Respons√°vel por Horas:** <@&${responsavelHoras}> (${nomeResponsavelHoras})`,
                            inline: false
                        }
                    )
                    .setThumbnail(interaction.guild.iconURL({ dynamic: true }))
                    .setTimestamp()
                    .setFooter({ 
                        text: `Hoje √†s ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`,
                        iconURL: interaction.user.displayAvatarURL({ dynamic: true })
                    });
                await suporteUser.send({ embeds: [suporteEmbed] });
            } catch (err) {
                console.error('Erro ao enviar mensagem para o suporte:', err.message);
            }
        } catch (err) {
            console.error('Erro detalhado ao processar intera√ß√£o:', err);
            
            const errorEmbed = new EmbedBuilder()
                .setColor('#FF0000')
                .setTitle('‚ùå Erro ao Salvar Configura√ß√£o')
                .setDescription('Ocorreu um problema ao salvar suas configura√ß√µes.')
                .addFields(
                    { 
                        name: '‚ö†Ô∏è Detalhes do Erro', 
                        value: `\`\`\`${err.message || 'Erro desconhecido'}\`\`\``, 
                        inline: false 
                    },
                    {
                        name: 'üîç Verifica√ß√£o',
                        value: 'Por favor, verifique se todos os dados est√£o corretos e tente novamente.',
                        inline: false
                    }
                )
                .setTimestamp()
                .setFooter({ 
                    text: 'Sistema de Bate Ponto Nychronos', 
                    iconURL: interaction.guild.iconURL({ dynamic: true }) 
                });
            
            await interaction.reply({ 
                embeds: [errorEmbed], 
                ephemeral: true 
            });
        }
    }
};

module.exports = { handlePainelCommand, handleInteraction };